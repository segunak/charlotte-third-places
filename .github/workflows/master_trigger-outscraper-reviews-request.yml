name: Trigger OutscraperReviewsRequest Azure Function

on:
  workflow_dispatch:

# Ensures that only one instance of this workflow runs at a time
concurrency: 
  group: outscraper-reviews-request
  cancel-in-progress: true

jobs:
  trigger-outscraper-reviews-request:
    runs-on: ubuntu-latest
    steps:    
      - name: Trigger Azure Function
        run: |
          #!/bin/bash
          set -euo pipefail
      
          API_URL="https://charlotte-third-places.azurewebsites.net/api/outscraper-reviews-request"
      
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "x-functions-key: ${{ secrets.AZURE_FUNCTION_KEY }}" \
            "$API_URL")
      
          http_status=$(tail -n1 <<< "$response")
          response_body=$(sed '$ d' <<< "$response")
      
          echo "HTTP Status: $http_status"
          echo "Response Body: $response_body"
      
          if [ "$http_status" -eq 200 ]; then
            echo "Action succeeded: Reviews request successfully processed."
          else
            echo "Action failed: Unable to process reviews request."
            echo "HTTP Status: $http_status"
            echo "Response Body: $response_body"
            exit 1
          fi
        shell: bash
